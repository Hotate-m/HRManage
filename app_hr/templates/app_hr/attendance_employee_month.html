{% extends "app_hr/hr_base.html" %}
{% load humanize %}

{% block title %}ประวัติการเข้างานรายคน{% endblock %}

{% block content %}
<div class="card-soft mb-3">
  <div class="card-soft-inner">
    <div class="d-flex flex-column flex-md-row justify-content-between gap-3 mb-3">
      <div>
        <span class="badge-pill pill-success mb-1">
          <i class="bi bi-person-check me-1"></i> Attendance
        </span>
        <div class="page-title mb-0">
          ประวัติการเข้างานรายคน (รายเดือน)
        </div>
        <div class="page-subtitle">
          เลือกพนักงานและเดือนที่ต้องการดูรายละเอียดการเข้างาน
        </div>
      </div>

      <form method="get" class="d-flex flex-column flex-md-row gap-2 align-items-md-end">
        <div>
          <label class="form-label small mb-1">พนักงาน</label>
          <select name="emp" class="form-select form-select-sm">
            {% for emp in employees %}
              <option value="{{ emp.code }}"
                      {% if employee and emp.code == employee.code %}selected{% endif %}>
                {{ emp.code }} - {{ emp.first_name }} {{ emp.last_name }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="form-label small mb-1">เดือน</label>
          <select name="month" class="form-select form-select-sm">
            {% for m in months %}
              <option value="{{ m }}" {% if m == month %}selected{% endif %}>
                เดือน {{ m }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="form-label small mb-1">ปี</label>
          <select name="year" class="form-select form-select-sm">
            {% for y in years %}
              <option value="{{ y }}" {% if y == year %}selected{% endif %}>
                {{ y }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div>
          <button type="submit" class="btn btn-primary btn-sm">
            <i class="bi bi-search me-1"></i> ดูข้อมูล
          </button>
        </div>
      </form>
    </div>

    {% if employee %}
      <div class="mb-3 small text-muted">
        แสดงผลสำหรับ:
        <strong>{{ employee.code }} - {{ employee.first_name }} {{ employee.last_name }}</strong>
        | งวดเดือน <strong>{{ month }}/{{ year }}</strong>
      </div>
    {% endif %}

    <div class="row g-3 mb-3">
      <div class="col-md-6 col-lg-4">
        <div class="metric-card">
          <div class="metric-label">มาทำงานปกติ</div>
          <div class="metric-value">{{ present_count|default:0|intcomma }}</div>
          <div class="metric-sub">status = present</div>
        </div>
      </div>
      <div class="col-md-6 col-lg-4">
        <div class="metric-card">
          <div class="metric-label">มาสาย</div>
          <div class="metric-value text-warning">{{ late_count|default:0|intcomma }}</div>
          <div class="metric-sub">status = late</div>
        </div>
      </div>
      <div class="col-md-6 col-lg-4">
        <div class="metric-card">
          <div class="metric-label">ขาดงาน</div>
          <div class="metric-value text-danger">{{ absent_count|default:0|intcomma }}</div>
          <div class="metric-sub">status = absent (มี record)</div>
        </div>
      </div>
      <div class="col-md-6 col-lg-4">
        <div class="metric-card">
          <div class="metric-label">ลา</div>
          <div class="metric-value text-info">{{ leave_count|default:0|intcomma }}</div>
          <div class="metric-sub">status = leave</div>
        </div>
      </div>
      <div class="col-md-6 col-lg-4">
        <div class="metric-card">
          <div class="metric-label">วันหยุด</div>
          <div class="metric-value text-success">{{ holiday_count|default:0|intcomma }}</div>
          <div class="metric-sub">status = holiday</div>
        </div>
      </div>
    </div>

    <div class="table-shell">
      <div class="table-responsive">
        <table class="table table-borderless mb-0 align-middle">
          <thead>
            <tr>
              <th style="width: 120px;">วันที่</th>
              <th style="width: 70px;">วัน</th>
              <th style="width: 110px;">เข้า</th>
              <th style="width: 110px;">ออก</th>
              <th style="width: 140px;">สถานะ</th>
              <th>หมายเหตุ</th>
            </tr>
          </thead>
          <tbody>
            {% for d in days %}
              {% with rec=d.record %}
              <tr>
                <td>{{ d.date|date:"Y-m-d" }}</td>
                <td>{{ d.date|date:"D" }}</td>
                <td>
                  {% if rec and rec.check_in %}
                    {{ rec.check_in|time:"H:i" }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>
                  {% if rec and rec.check_out %}
                    {{ rec.check_out|time:"H:i" }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>
                  {% if rec %}
                    {% if rec.status == 'present' %}
                      <span class="badge bg-success-subtle text-success">
                        {{ rec.get_status_display }}
                      </span>
                    {% elif rec.status == 'late' %}
                      <span class="badge bg-warning-subtle text-warning">
                        {{ rec.get_status_display }}
                      </span>
                    {% elif rec.status == 'absent' %}
                      <span class="badge bg-danger-subtle text-danger">
                        {{ rec.get_status_display }}
                      </span>
                    {% elif rec.status == 'leave' %}
                      <span class="badge bg-info-subtle text-info">
                        {{ rec.get_status_display }}
                      </span>
                    {% elif rec.status == 'holiday' %}
                      <span class="badge bg-secondary-subtle text-secondary">
                        {{ rec.get_status_display }}
                      </span>
                    {% else %}
                      {{ rec.get_status_display }}
                    {% endif %}
                  {% else %}
                    <span class="text-muted small">ไม่มีบันทึก</span>
                  {% endif %}
                </td>
                <td>
                  {% if rec and rec.remark %}
                    {{ rec.remark }}
                  {% else %}
                    <span class="text-muted small">-</span>
                  {% endif %}
                </td>
              </tr>
              {% endwith %}
            {% empty %}
              <tr>
                <td colspan="6" class="text-center text-muted py-3">
                  ยังไม่มีข้อมูลการเข้างานสำหรับเดือนนี้
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>
{% endblock %}
