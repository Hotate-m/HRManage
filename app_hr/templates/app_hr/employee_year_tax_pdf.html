{% load humanize %}
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>ใบรับรองเงินเดือนและภาษีหัก ณ ที่จ่าย - {{ employee.code }} - {{ year }}</title>

  <!-- ฟอนต์ไทย -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* ขนาดกระดาษ A4 ตอนพิมพ์ / Export PDF */
    @page {
      size: A4;
      margin: 18mm 18mm 20mm 18mm;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Prompt", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 12px;
      color: #111827;
      background: #f3f4f6; /* ให้เห็นกระดาษลอยกลางจอ */
    }

    .sheet {
      position: relative;
      width: 100%;
      max-width: 190mm;          /* ใกล้ A4 แต่เผื่อขอบนิดหน่อย */
      min-height: 270mm;
      margin: 16px auto 24px;
      background: #ffffff;
      border-radius: 6px;
      box-shadow: 0 12px 32px rgba(15,23,42,.16);
      overflow: hidden;
    }

    .watermark {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 96px;
      font-weight: 700;
      letter-spacing: 0.3em;
      color: rgba(148,163,184,.18);
      z-index: 0;
      pointer-events: none;
      user-select: none;
    }

    .content {
      position: relative;
      z-index: 1;
    }

    .inner {
      padding: 14mm 14mm 16mm 14mm;   /* ระยะห่างจากขอบกระดาษ */
    }

    h1, h2 {
      margin: 0;
      text-align: center;
      font-weight: 600;
    }

    h1 {
      font-size: 18px;
    }

    h2 {
      font-size: 14px;
      margin-top: 4px;
    }

    .header-row {
      margin-top: 12px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }

    .company-block {
      text-align: left;
      font-size: 12px;
    }

    .company-name {
      font-weight: 600;
    }

    .ref-block {
      text-align: right;
      font-size: 11px;
      color: #6b7280;
    }

    .info-grid {
      margin-top: 14px;
      display: grid;
      grid-template-columns: 160px 1fr;
      row-gap: 4px;
      column-gap: 8px;
      font-size: 12px;
    }

    .info-label {
      font-weight: 500;
    }

    .info-value {
      border-bottom: 1px solid #e5e7eb;
      min-height: 16px;
      padding-bottom: 1px;
    }

    .section-title {
      margin-top: 16px;
      margin-bottom: 6px;
      font-weight: 600;
      font-size: 13px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 11px;
    }

    th, td {
      border: 1px solid #d1d5db;
      padding: 4px 6px;
      vertical-align: middle;
    }

    th {
      background: #f3f4f6;
      font-weight: 600;
      text-align: center;
    }

    .text-center { text-align: center; }
    .num {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .total-row td {
      font-weight: 600;
      background: #f9fafb;
    }

    .mt-4 { margin-top: 16px; }
    .mt-2 { margin-top: 8px; }

    .small {
      font-size: 10px;
      color: #6b7280;
    }

    .signature-row {
      margin-top: 26px;
      display: flex;
      justify-content: flex-end;
    }

    .signature-box {
      width: 260px;
      text-align: center;
      font-size: 11px;
    }

    .signature-line {
      margin-top: 32px;
      border-bottom: 1px solid #111827;
      margin-inline: 40px;
    }

    .signature-label {
      margin-top: 4px;
    }

    .signer-name {
      margin-top: 8px;
      font-weight: 500;
    }

    .sign-date {
      margin-top: 4px;
    }
  </style>
</head>
<body>

<div class="sheet">
  <!-- ลายน้ำ CMSK กลางหน้า -->
  <div class="watermark">CMSK</div>

  <div class="content">
    <div class="inner">

      <!-- ชื่อเอกสาร -->
      <h1>ใบรับรองเงินเดือนและภาษีหัก ณ ที่จ่าย</h1>
      <h2>ประจำปีภาษี {{ year }}</h2>

      <!-- หัวมุมบน: บริษัท / ref -->
      <div class="header-row">
        <div class="company-block">
          <div class="company-name">
            {{ company.company_name|default:company.name|default:"(ยังไม่ตั้งค่าชื่อบริษัท)" }}
          </div>
          {% if company.company_address %}
            <div>{{ company.company_address }}</div>
          {% endif %}
        </div>

        <div class="ref-block">
          เลขที่เอกสาร: -
        </div>
      </div>

      <!-- ข้อมูลพนักงาน -->
      <div class="info-grid">
        <div class="info-label">ชื่อพนักงาน:</div>
        <div class="info-value">
          {{ employee.first_name }} {{ employee.last_name }}
        </div>

        <div class="info-label">รหัสพนักงาน:</div>
        <div class="info-value">
          {{ employee.code }}
        </div>

        <div class="info-label">ตำแหน่ง:</div>
        <div class="info-value">
          {{ employee.position }}
        </div>

        <div class="info-label">เลขประจำตัวประชาชน:</div>
        <div class="info-value">
          {{ employee.citizen_id }}
        </div>

        <div class="info-label">ที่อยู่ติดต่อ:</div>
        <div class="info-value">
          {{ employee.address }}
        </div>
      </div>

      <!-- 1. รายได้และภาษีหัก ณ ที่จ่าย -->
      <div class="section-title mt-4">1. รายได้และภาษีหัก ณ ที่จ่าย</div>

      <table>
        <thead>
          <tr>
            <th style="width: 80px;">เดือน</th>
            <th style="width: 110px;">รายรับรวม (GROSS)</th>
            <th style="width: 110px;">รายหักรวม</th>
            <th style="width: 110px;">รับสุทธิ (NET)</th>
            <th style="width: 110px;">ภาษีหัก ณ ที่จ่าย</th>
          </tr>
        </thead>
        <tbody>
          {% for p in payslips %}
            <tr>
              <td class="text-center">
                {{ p.period.month }}/{{ p.period.year }}
              </td>
              <td class="num">
                {{ p.gross_income|default:0|floatformat:2|intcomma }}
              </td>
              <td class="num">
                {{ p.total_deduction|default:0|floatformat:2|intcomma }}
              </td>
              <td class="num">
                {{ p.net_income|default:0|floatformat:2|intcomma }}
              </td>
              <td class="num">
                <!-- ถ้าอยากลงภาษีรายเดือนทีหลัง ค่อยเติม logic ตรงนี้ -->
                -
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="5" class="text-center small">
                ยังไม่มีข้อมูลเงินเดือนในปีภาษีนี้
              </td>
            </tr>
          {% endfor %}

          <tr class="total-row">
            <td class="text-center">รวมทั้งปี</td>
            <td class="num">
              {{ total_gross|default:0|floatformat:2|intcomma }}
            </td>
            <td class="num">
              {{ total_deduct|default:0|floatformat:2|intcomma }}
            </td>
            <td class="num">
              {{ total_net|default:0|floatformat:2|intcomma }}
            </td>
            <td class="num">
              {{ wht_total|default:0|floatformat:2|intcomma }}
            </td>
          </tr>
        </tbody>
      </table>

      <!-- 2. ประกันสังคม -->
      <div class="section-title mt-4">2. ประกันสังคมที่นำส่งจากเงินเดือนพนักงาน</div>
      <div class="mt-2">
        ยอดเงินสมทบประกันสังคมที่หักจากเงินเดือนพนักงานตลอดปีภาษี {{ year }}
        เท่ากับ <strong>{{ ssf_total|default:0|floatformat:2|intcomma }}</strong> บาท
      </div>

      <div class="small mt-2">
        หมายเหตุ: เอกสารฉบับนี้จัดทำจากข้อมูลในระบบเงินเดือน
        เพื่อใช้เป็นหลักฐานยืนยันรายได้ และภาษีหัก ณ ที่จ่ายของพนักงานในปีภาษี {{ year }}
      </div>

      <!-- ลายเซ็น -->
      <div class="signature-row">
        <div class="signature-box">
          <div class="signature-line"></div>
          <div class="signature-label">ลงชื่อ...............................................................</div>
          <div class="signer-name">
            ({{ company.authorized_signer_name|default:"ผู้มีอำนาจลงนาม" }})
          </div>
          <div class="sign-date">
            ออกให้เมื่อวันที่ {{ generated_at|date:"d/m/Y" }}
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

</body>
</html>
